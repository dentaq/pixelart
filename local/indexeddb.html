<!DOCTYPE html>
<html lang="ja"> 
<head>
<meta charset="UTF-8" />
<title>Indexed Database API 簡易サンプル</title>
<style>
body {
	font-size: 85%;
}
#list {
	margin-top: 1.5em;
	border-collapse: collapse;
	border-spacing: 0;
	width: 100%;
	margin-bottom: 30px;
}
#list th,td {
	padding: 10px 20px;
	color: #1D5C79;
}
#list th {
	border-bottom: 2px solid #1D5C79;
	text-align: left;
}
#list td {
	border-bottom: 1px solid #DDD;
}
details {
	display: block;
	margin-bottom: 1em;
}
.detail {
	border: 1px solid #cccccc;
	border-radius: 10px;
	margin-top: 0.5em;
	padding: 0.2em 1em;
}
menu {
	display: block;
	padding-left: 0;
}
</style>
</head>
<body>
<h1>Indexed Database API 簡易サンプル</h1>
<details>
	<summary>レコード追加</summary>
	<div class="detail">
		<form action="#" id="addform" method="post">
			<p>
				<label>名前: <input type="text" name="name" id="name" required></label> /
				<label>メール: <input type="email" name="email" id="email" required></label>
				<input type="submit" value="追加">
			</p>
		</form>
	</div>
</details>
<details>
	<summary>データ操作</summary>
	<div class="detail">
		<menu>
			<button type="button" id="clear-btn">全レコード・クリア</button>
			<button type="button" id="del-store-btn">オブジェクト・ストア削除</button>
			<button type="button" id="del-btn">DB削除</button>
		</menu>
	</div>
</details>
<details open>
	<summary>検索条件</summary>
	<div class="detail">
		<form action="#" id="search-form" method="post">
			<p>
				<select id="skey" name="skey">
					<option value="">-</option>
					<option value="id">ID</option>
					<option value="name">名前</option>
					<option value="email">メール</option>
				</select>
				<input type="text" name="svalue" id="svalue">
				<input type="submit" value="検索">
				<small>※ 前方一致検索</small>
			</p>
		</form>
	</div>
</details>


<table id="list">
	<caption>レコード一覧</caption>
	<thead>
		<tr>
			<th>ID</th>
			<th>名前</th>
			<th>メール</th>
			<th>削除</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>-</td>
			<td>-</td>
			<td>-</td>
			<td>-</td>
		</tr>
	</tbody>
</table>


<script>
(function () {

var db = null;
var indexedDB = null;
var IDBTransaction = null;
var IDBKeyRange = null;
var IDBCursor = null;

var db_name = 'mydatabase';
var db_version = '1.0';
var store_name = 'customers';

window.addEventListener('load', function() {
	initDatabase();
}, false);

function initDatabase() {
	indexedDB = window.indexedDB || window.msIndexedDB || window.mozIndexedDB || window.webkitIndexedDB;
	if( ! indexedDB ) { return; }
	IDBTransaction = window.IDBTransaction || window.msIDBTransaction || window.mozIDBTransaction || window.webkitIDBTransaction;
	IDBKeyRange = window.IDBKeyRange || window.msIDBKeyRange || window.mozIDBKeyRange || window.webkitIDBKeyRange;
	IDBCursor = window.IDBCursor || window.msIDBCursor || window.mozIDBCursor || window.webkitIDBCursor;
	// IDBRequestオブジェクト
	var request = indexedDB.open(db_name, db_version);
	// DB接続成功時のコールバック
	request.onsuccess = function(event) {
		// IDBDatabaseオブジェクト
		db = event.target.result;
		// オブジェクト・ストアの存在をチェック
		if( db.objectStoreNames.contains(store_name) ) {
			// 全レコード表示
			showAllRecoreds();
		} else {
			createObjectStore();
		}
	};
	// DB接続失敗時のコールバック
	request.onerror = function(event) {
		alert('データベース接続に失敗しました。(' + request.errorCode + ')');
	};
}

// ------------------------------------------------------------------
// オブジェクト・ストアの生成
// ------------------------------------------------------------------
function createObjectStore() {
	// DBバージョンをセット
	var request = db.setVersion(db_version);
	request.onsuccess = function(event) {
		// オブジェクト・ストアを生成（idをキーにする）
		var store = db.createObjectStore(store_name, { keyPath: 'id', autoIncrement: true });
		// 名前を格納するインデックスを生成
		store.createIndex('name', 'name', { unique: false });
		// メールアドレスを格納するインデックスを生成
		store.createIndex("email", "email", { unique: true });
	};
	request.onerror = function(event) {
		alert('オブジェクト・ストアの生成に失敗しました。(' + event.target.errorCode + ')');
	};
}

// ------------------------------------------------------------------
// オブジェクト・ストアの削除
// ------------------------------------------------------------------
document.getElementById('del-store-btn').addEventListener('click', deleteObjectStore, false);

function deleteObjectStore() {
	if( ! db.objectStoreNames.contains(store_name) ) { return; }
	var request = db.setVersion(db_version);
	request.onsuccess = function(event) {
		db.deleteObjectStore(store_name);
		alert('オブジェクト・ストア ' + store_name + ' の削除に成功しました。');
	};
	request.onerror = function(event) {
		alert('オブジェクト・ストア ' + store_name + ' の削除に失敗しました。(' + trans.errorCode + ')');
	};
}

// ------------------------------------------------------------------
// レコード一覧
// ------------------------------------------------------------------

document.querySelector('#search-form').addEventListener('submit', function(event) {
	// デフォルト・アクションをキャンセル
	event.preventDefault();
	//
	var skey = document.querySelector('#skey').value;
	var svalue = document.querySelector('#svalue').value;
	showAllRecoreds(skey, svalue);
}, false);


function showAllRecoreds(skey, svalue) {
	if( skey === undefined ) { skey = ''; }
	if( svalue === undefined ) { svalue = ''; }
	var tbody = document.querySelector('#list').tBodies.item(0);
	tbody.innerHTML = '';
	//
	var trans = db.transaction(store_name, IDBTransaction.READ_ONLY);
	var store = trans.objectStore(store_name);
	var request;
	if( skey === 'id' && svalue !== '' ) {
		svalue = parseInt(svalue, 10);
		var keyRange = IDBKeyRange.only(svalue);
		request = store.openCursor(keyRange, IDBCursor.NEXT);
	} else if( skey.match(/^(name|email)$/) && svalue !== '' ) {
//		var keyRange = IDBKeyRange.only(svalue);
//		var keyRange = IDBKeyRange.bound(svalue, svalue, false, false);
		var keyRange = IDBKeyRange.lowerBound(svalue);
		request = store.index(skey).openCursor(keyRange, IDBCursor.NEXT);
	} else {
		var keyRange = IDBKeyRange.lowerBound(0);
		request = store.openCursor(keyRange, IDBCursor.NEXT);
	}
	request.onsuccess = function(e) {
		var cursor = e.target.result;
		if( ! cursor ) { return; }
		if( skey.match(/^(name|email)$/) && svalue !== '' ) {
			if( cursor.value[skey].indexOf(svalue, 0) < 0 ) { return; }
		}
		var tr = createTableRow(cursor);
		tbody.appendChild(tr);
		cursor.continue();
	};
}

function createTableRow(cursor) {
	var tr = document.createElement('tr');
	//
	var cols = ['id', 'name', 'email'];
	for( var i=0; i<cols.length; i++ ) {
		var td = document.createElement('td');
		if( cursor.value ) {
			td.textContent = cursor.value[cols[i]];
		}
		tr.appendChild(td);
	}
	if( ! cursor.value ) {
//		showRecord(tr, cursor.primaryKey);
	}
	//
	var td = document.createElement('td');
	var btn = document.createElement('button');
	btn.type = 'button';
	btn.setAttribute('data-id', cursor.primaryKey);
	btn.textContent = '削除';
	td.appendChild(btn);
	tr.appendChild(td);
	//
	btn.addEventListener('click',function(event) {
		var id = event.target.getAttribute('data-id');
		deleteRecord(id);
	}, false);
	//
	return tr;
}

/*
function showRecord(tr, id) {
	var trans = db.transaction(store_name, IDBTransaction.READ_ONLY);
	var store = trans.objectStore(store_name);
	var request = store.get(id);
	request.onsuccess = function(e) {
		var value = e.target.result;
		var td_list = tr.querySelectorAll('td');
		td_list.item(0).textContent = value['id'];
		td_list.item(1).textContent = value['name'];
		td_list.item(2).textContent = value['email'];
	};
}
*/

// ------------------------------------------------------------------
// レコードの追加
// ------------------------------------------------------------------
document.querySelector('#addform').addEventListener('submit', function(event) {
	// デフォルト・アクションをキャンセル
	event.preventDefault();
	// 値を取得
	var name = document.querySelector('#name').value;
	var email = document.querySelector('#email').value;
	if( ! name || ! email ) {
		alert('すべての項目が必須です。');
	}
	// DBに登録
	var trans = db.transaction(store_name, IDBTransaction.READ_WRITE);
	var store = trans.objectStore(store_name);
	var request = store.add({
		name  : name,
		email : email
	});
	request.onsuccess = function(event) {
		alert('[' + request.result + '] を登録しました。');
		showAllRecoreds();
	};
	request.onerror = function(event) {
		alert('レコードの追加に失敗しました。(' + event.target.errorCode + ')');
	};
}, false);

// ------------------------------------------------------------------
// レコードの削除
// ------------------------------------------------------------------
function deleteRecord(id) {
	var trans = db.transaction(store_name, IDBTransaction.READ_WRITE);
	var store = trans.objectStore(store_name);
	id = parseInt(id, 10);
	var request = store.delete(id);
	request.onsuccess = function(e) {
		showAllRecoreds();
		alert('削除に成功しました。');
	};
	request.onerror = function(e) {
		alert('レコードの削除に失敗しました。(' + e.target.errorCode + ')');
	};
}

// ------------------------------------------------------------------
// 全レコード・クリア
// ------------------------------------------------------------------
document.querySelector('#clear-btn').addEventListener('click', clearAllRecoreds, false);

function clearAllRecoreds() {
	var trans = db.transaction(store_name, IDBTransaction.READ_WRITE);
	var store = trans.objectStore(store_name);
	var request = store.clear();
	request.onsuccess = function(e) {
		showAllRecoreds();
		alert('全レコード・クリアに成功しました。');
	};
	request.onerror = function(e) {
		alert('全レコード・クリアに失敗しました。(' + e.target.errorCode + ')');
	};
}

// ------------------------------------------------------------------
// DB削除
// ------------------------------------------------------------------
document.querySelector('#del-btn').addEventListener('click', deleteDatabase, false);

function deleteDatabase() {
	if( ! indexedDB.deleteDatabase ) {
		alert('ご利用のブラウザーに indexedDB.deleteDatabase() メソッドが実装されていないため、データベースの削除はできません。');
		return;
	}
	var request = indexedDB.deleteDatabase(db_name);
	request.onsuccess = function(event) {
		initDatabase();
		alert('データベース削除に成功しました。');
	};
	request.onerror = function(event) {
		alert('データベース削除に失敗しました。(' + request.errorCode + ')');
	};
}

})();
</script>

</body>
</html>